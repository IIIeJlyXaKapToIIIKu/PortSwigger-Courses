[Source](https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-duplicated-in-cookie)
## Task
The email address change functionality in this lab is vulnerable to CSRF. To solve the task, we need to perform a CSRF attack that changes the victim's email address. We should use the provided exploit server to host our attack.
We can log in to our account using the following credentials: `wiener:peter`

> **Note**  
> The default values ​​for SameSite vary across browsers. Since the victim is using Chrome, we recommend also using Chrome (or Burp's built-in Chromium browser) to test the exploit.
## Solution
Go to the task site

![image](images/20241225165338.png)

Log in as `wiener`

![image](images/20241225165358.png)

Change email and intercept the request via `Burp Suite`

![image](images/20241225165414.png)

Examine the `POST /my-account/change-email` request and notice that it does not contain unpredictable tokens, so it may be vulnerable to CSRF if we can bypass the `SameSite cookie` restrictions.
Look at the response to our `POST /login` request. We see that the site does not explicitly specify any `SameSite` settings when setting session `cookies`. As a result, the browser will use the `Lax` level by default.
We understand that this means sending a session `cookie` in cross-site `GET` requests, provided that they occur at the top navigation level.

![image](images/20241225165557.png)

We send a `POST /my-account/change-email` request to `Repeater` and click `Change request method` in it. We send the request and see that `endpoint` only accepts `POST` requests.

![image](images/20241225165536.png)

Let's try changing the first line in the request like this:
```Request
GET /my-account/change-email?email=test%40gmail.com&_method=POST HTTP/2
```
Sending the request

![image](images/20241225165624.png)

We see that the server accepted this request. Go to the account page and see that the email has changed

![image](images/20241225165753.png)

Open `Exploit Server` and paste the code into the `Body` field
```JS
<script> document.location = "https://YOUR-LAB-ID.web-security-academy.net/my-account/change-email?email=pwned@web-security-academy.net&_method=POST"; </script>
```

![image](images/20241225165953.png)

Then click `Store` and `Deliver exploit to victim`

![image](images/20241225170017.png)
